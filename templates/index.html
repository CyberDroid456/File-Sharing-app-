<!DOCTYPE html>
<html>
<head>
  <title>File Sharing Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script>
    (function() {
        const savedTheme = localStorage.getItem('theme');
        const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const theme = savedTheme || (systemPrefersDark ? 'dark' : 'light');
        document.documentElement.setAttribute('data-theme', theme);
    })();
  </script>
</head>
<body>
  <header>
    <h1>Welcome, {{ user }} ({{ role }})</h1>
    <div>
      <a href="{{ url_for('my_shares') }}">🔗 My Shares</a>
      <a href="{{ url_for('logout') }}">Logout</a>
    </div>
  </header>

  <main class="container">
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="flash-messages">
          {% for message in messages %}
            <div class="flash-message">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <section>
      <h2>Upload a File</h2>
      <form id="uploadForm" action="{{ url_for('upload') }}" method="POST" enctype="multipart/form-data">
        <input type="file" name="file" id="fileInput" required>
        <button type="submit" id="uploadButton">Upload</button>
        
        <div class="upload-progress" id="uploadProgress">
          <div class="progress-bar" id="progressBar"></div>
          <div class="upload-status" id="uploadStatus">Uploading...</div>
        </div>
      </form>
    </section>

    <section>
      <h2>Organize Files</h2>
      <form id="createFolderForm" action="{{ url_for('create_folder') }}" method="POST">
        <input type="text" name="folder_name" placeholder="Enter folder name" required>
        <button type="submit">Create Folder</button>
      </form>
    </section>

    <div style="margin: 20px 0;">
      <input type="text" id="fileSearch" placeholder="🔍 Search files..." 
             style="padding: 10px; width: 100%; border-radius: 8px; border: 2px solid #e2e8f0;">
    </div>

    <section>
      <h2>Available Files</h2>
      {% if files %}
        <table class="file-table">
          <thead>
            <tr>
              <th>Filename</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for file in files %}
              <tr>
                <td>
                  {% set ext = file.name.split('.')[-1].lower() if '.' in file.name else 'folder' %}
                  <span class="file-icon 
                    {% if ext in ['pdf'] %}file-pdf
                    {% elif ext in ['png', 'jpg', 'jpeg', 'gif'] %}file-image  
                    {% elif ext in ['doc', 'docx', 'txt'] %}file-document
                    {% elif ext in ['zip', 'rar'] %}file-archive
                    {% else %}file-other{% endif %}">
                  </span>
                  {{ file.name }}
                  <br><small style="color: #666;">{{ file.size }}</small>
                </td>
                <td>
                  {% if file.is_file %}
                    <a href="{{ url_for('preview_file', filename=file.name) }}" class="download-btn" style="background: #6b46c1;">👁️ Preview</a>
                    <a href="{{ url_for('download', filename=file.name) }}" class="download-btn">📥 Download</a>
                    <button onclick="openShareModal('{{ file.name }}')" class="share-btn">🔗 Share</button>
                  {% else %}
                    <a href="{{ url_for('browse', folder_path=file.name) }}" class="download-btn">📁 Open Folder</a>
                  {% endif %}
                  {% if role == "admin" %}
                    <button onclick="handleDelete('{{ file.name }}', '{{ url_for('delete_file', filename=file.name) }}')" 
                            class="delete-btn">
                      🗑️ Delete
                    </button>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <p>No files available.</p>
      {% endif %}
    </section>

    {% if role == "admin" %}
      <section>
        <h2>Admin Controls</h2>
        <a href="{{ url_for('logs') }}" class="download-btn">View Activity Logs</a>
      </section>
    {% endif %}
  </main>

  <!-- Share Modal -->
  <div id="shareModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
      <span class="close" onclick="closeShareModal()">&times;</span>
      <h3>🔗 Share File</h3>
      <div id="shareModalContent">
        <div class="form-group">
          <label>Share Link:</label>
          <input type="text" id="shareLinkInput" readonly 
                 style="width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ddd;">
        </div>
        
        <div class="form-group">
          <label style="display: flex; align-items: center;">
            <input type="checkbox" id="expireCheck" checked> 
            <span style="margin-left: 8px;">Expire in 7 days</span>
          </label>
        </div>
        
        <div class="form-group">
          <label style="display: flex; align-items: center;">
            <input type="checkbox" id="passwordCheck"> 
            <span style="margin-left: 8px;">Password protect</span>
          </label>
          <input type="password" id="sharePassword" placeholder="Enter password" 
                 style="width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ddd; margin-top: 5px; display: none;">
        </div>
        
        <div style="display: flex; gap: 10px; margin-top: 20px;">
          <button onclick="copyShareLink()" class="download-btn">📋 Copy Link</button>
          <button onclick="closeShareModal()" style="background: #a0aec0;">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script src="{{ url_for('static', filename='script.js') }}"></script>
</body>
</html>